name: Build Windows Portable

# Only run on the windows-installer branch when you push
on:
  push:
    branches:
      - windows-installer
  workflow_dispatch:  # Allows manual triggering from GitHub UI

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install MSYS2
      uses: msys2/setup-msys2@v2
      with:
        msystem: MINGW64
        update: true
        install: >-
          mingw-w64-x86_64-gtk4
          mingw-w64-x86_64-libadwaita
          mingw-w64-x86_64-python
          mingw-w64-x86_64-python-pip
          mingw-w64-x86_64-python-gobject
          mingw-w64-x86_64-gtksourceview5
          mingw-w64-x86_64-python-pandas
          mingw-w64-x86_64-python-requests
          mingw-w64-x86_64-python-pillow
          mingw-w64-x86_64-python-psutil

    - name: Install Python dependencies in venv
      shell: msys2 {0}
      run: |
        # Create a virtual environment
        python -m venv build-venv
        source build-venv/bin/activate

        # Install packages not available in MSYS2
        pip install python-dotenv mutagen typer keyring pymongo pyinstaller

        # Verify PyInstaller is available
        pyinstaller --version

    - name: Build Windows executable
      shell: msys2 {0}
      run: |
        source build-venv/bin/activate
        cd windows_installer
        bash build_windows.sh

    - name: Upload build artifact
      uses: actions/upload-artifact@v4
      with:
        name: ipod-wrapped-windows-portable
        path: windows_installer/dist/ipod-wrapped-windows-portable.zip
        retention-days: 30

    - name: Display build info
      shell: msys2 {0}
      run: |
        echo "Build completed successfully!"
        echo "Download the artifact from the Actions tab"
        ls -lh windows_installer/dist/ipod-wrapped-windows-portable.zip
