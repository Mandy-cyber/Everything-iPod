name: Build Windows Portable

# Only run on the windows-installer branch when you push
on:
  push:
    branches:
      - windows-installer
  workflow_dispatch:  # Allows manual triggering from GitHub UI

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install MSYS2
      uses: msys2/setup-msys2@v2
      with:
        msystem: MINGW64
        update: true
        install: >-
          mingw-w64-x86_64-gtk4
          mingw-w64-x86_64-libadwaita
          mingw-w64-x86_64-python
          mingw-w64-x86_64-python-pip
          mingw-w64-x86_64-python-gobject
          mingw-w64-x86_64-gtksourceview5

    - name: Install Python dependencies
      shell: msys2 {0}
      run: |
        cd ipod_wrapped
        python -m pip install -r requirements.txt
        python -m pip install pyinstaller

    - name: Build Windows executable
      shell: msys2 {0}
      run: |
        cd windows_installer
        bash build_windows.sh

    - name: Upload build artifact
      uses: actions/upload-artifact@v4
      with:
        name: ipod-wrapped-windows-portable
        path: windows_installer/dist/ipod-wrapped-windows-portable.zip
        retention-days: 30

    - name: Display build info
      shell: msys2 {0}
      run: |
        echo "Build completed successfully!"
        echo "Download the artifact from the Actions tab"
        ls -lh windows_installer/dist/ipod-wrapped-windows-portable.zip
